{% extends "base.html" %}
{% load static %}
{% load render_bundle from webpack_loader %}

{% block content %}
<div class="row">
    <div class="col-md-6 col-md-offset-3">
        <div class="card">
            <div class="cardface">
                {{ form.media.css }}
                <form action="." method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <h3>Overview</h3>
                    <div class="form-group">
                        <label class="control-label" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
                        <input class="form-control" id="{{ form.name.id_for_label }}" maxlength="30" name="{{ form.name.html_name }}" type="text" placeholder="{{ form.name.label }}" value="{{ form.name.value|default_if_none:'' }}"/>
                        {{ form.name.errors }}
                    </div>
                    <div class="form-group">
                        <label class="control-label" for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
                        <textarea class="form-control" id="{{ form.description.id_for_label }}" name="{{ form.description.html_name }}">{{ form.description.value|default_if_none:'' }}</textarea>
                        {{ form.description.errors }}
                    </div>
                    <br />
                    <h3>Data Upload Instructions</h3>
                    <p>You can upload an additional data file that contains text (and optionally labels) for your project.  The file <strong>must pass the following checks</strong>:</p>
                    <ul class="list-group">
                        <li class="list-group-item"><code>.csv</code> or <code>.tsv</code> file</li>
                        <li class="list-group-item">Two columns with headers <code>Text</code> and <code>Label</code></li>
                        <li class="list-group-item">Less than 4GBs</li>
                    </ul>
                    <p>The <code>Text</code> column should have the text of your data which will be annotated by users.  The <code>Label</code> column should have any pre-existing labels for the corresponding text.  If you have no labels then this column can be blank.</p>
                    <p>SMART restricts your project to having two million unique data objects.  Any row after the two millionth will be discarded and any duplicated text that appears previously in the file will also be discarded.</p>
                    {% if num_data < 2000000 %}
                    <div class="form-group">
                        <label class="control-label" for="{{ form.data.id_for_label }}">{{ form.data.label }}</label>
                        <input class="form-control" id="{{ form.data.id_for_label }}" maxlength="30" name="{{ form.data.html_name }}" type="file" placeholder="{{ form.data.label }}" />
                        {{ form.data.errors }}
                    </div>
                    {% else %}
                    <div>
                        <p>You already have two million unique data objects for this project, you can not upload additional data.</p>
                    </div>
                    {% endif %}
                    <br />
                    <h3>Project Permissions</h3>
                    <table class="table table-striped">
                        {{ permissions.management_form }}
                        {{ permissions.non_form_errors }}
                        {% for form in permissions.forms %}
                            {% if forloop.first %}
                                <thead>
                                <tr>
                                    {% for field in form.visible_fields %}{% if field != data %}
                                        <th>{{ field.label|capfirst }}</th>
                                    {% endif %}{% endfor %}
                                </tr>
                                </thead>
                            {% endif %}
                            <tr class="formset_row_perm">
                                {% for field in form.visible_fields %}
                                    <td>
                                        {# Include the hidden fields in the form #}
                                        {% if forloop.first %}
                                            {% for hidden in form.hidden_fields %}
                                                {{ hidden }}
                                            {% endfor %}
                                        {% endif %}
                                        {{ field.errors.as_ul }}
                                        {{ field }}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </table>
                    <div class="form-group">
                        <button class="btn btn-primary" type="submit">Submit</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_body %}
<script type="text/javascript">
    $('.formset_row_label').formset({
        addText: 'add label',
        deleteText: 'remove label',
        prefix: '{{ labels.prefix }}',
        added: function () {
            // Reset drop down and errors from both columns when adding new rows
            $('tr.formset_row_label').last().children(':first').find('ul.errorlist li').empty();
        }
    });
    $('.formset_row_perm').formset({
        addText: 'add permissions',
        deleteText: 'remove permission',
        prefix: '{{ permissions.prefix }}',
        added: function () {
            // Reset drop down and errors from both columns when adding new rows
            $('tr.formset_row_perm').last().children(':first').find('option:eq(0)').prop('selected', true);
            $('tr.formset_row_perm').last().children().eq(1).find('option:eq(0)').prop('selected', true);
            $('tr.formset_row_perm').last().children(':first').find('ul.errorlist li').empty();
            $('tr.formset_row_perm').last().children().eq(1).find('ul.errorlist li').empty();
        }
    });
</script>
{% endblock %}
