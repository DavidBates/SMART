{% extends "base.html" %}
{% load render_bundle from webpack_loader %}

{% block page_title %}Admin{% endblock %}
{% block heading %}Admin - {{object}}{% endblock %}

{% block content %}
<div class="card full">
    <div class="cardface">
        <h2>{{ project.name }}</h2>
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item active">
                    <a data-toggle="tab" href="#label" class="nav-link">Labeled Data</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#model" class="nav-link">Active Learning Model</a>
                </li>
            </ul>
        </div>
        <div class="tab-content">
            <div id="label" class="tab-pane fade in active">
                <div class="row">
                    <div class="col-md-6">
                        <h3>Label Distribution</h3>
                        <div id="distribution_chart" style="height:300px">
                            <svg class="nvd3-svg"></svg>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h3>Time To Label</h3>
                        <div id="timer_chart" style="height:300px">
                            <svg class="nvd3-svg"></svg>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h3>Labeled Data Table</h3>
                        <table id="labeled_data_table" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Text</th>
                                    <th>Label</th>
                                    <th>Coder</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <h3>Change Label Table</h3>
                        <table id="label_changes_data_table" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>Text</th>
                                    <th>Coder</th>
                                    <th>Old Label</th>
                                    <th>New Label</th>
                                    <th>Timestamp</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
            <div id="model" class="tab-pane fade in">
                <div class="row">
                    <div class="col-md-12">
                        <h3 id="model_metrics">Model Metrics: Accuracy
                          <span id="model_metric_icon"
                          data-toggle="tooltip"
                          class="glyphicon glyphicon-question-sign model_question_tooltip"
                          title="The percent guessed correctly by the model."></span>
                        </h3>
                        <div class="form-group">
                            <label for="metric_select">Select the metric to appear on the chart:</label>
                            <select class="form-control" id="metric_select">
                                <option class = "metric_option" value="accuracy">
                                Accuracy</option>
                                <option class = "metric_option" value="f1"
                                >F1 Score</option>
                                <option class = "metric_option" value="precision"
                                >Precision</option>
                                <option class = "metric_option" value="recall"
                                >Recall</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div id="metric_chart" style="height:350px">
                                    <svg class="nvd3-svg"></svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-12">
                        <h3>Predictions</h3>
                        <table id="predicted_data_table" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
                            <thead>
                                <tr>
                                    <th>Text</th>
                                    <th>Predicted Probability</th>
                                    <th>Predicted Label</th>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts_body %}
<script>
/*
 *  Make ajax call to `label_distribution` route.  This will fetch data to
 *  populate the discrete multi bar chart and show the label distribution
 *  per user.
 */
$.ajax({
    method: "GET",
    url: '/api/label_distribution/' + {{ project.pk }} + '/',
    success: function (response) {
        nv.addGraph(function() {
            var chart = nv.models.multiBarChart()
                .color(["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"])
                .duration(300)
                .margin({bottom: 70, left: 70})
                .groupSpacing(0.1)
            ;
            chart.xAxis
                .axisLabel("User")
                .axisLabelDistance(15)
                .showMaxMin(false)
            ;
            chart.yAxis
                .axisLabel("Number of Data Annotated")
                .axisLabelDistance(-5)
                .tickFormat(d3.format(',.01f'))
            ;
            chart.noData("Insufficient labeled data -- please code more documents");
            d3.select('#distribution_chart svg')
                .datum(response)
                .call(chart);
            nv.utils.windowResize(chart.update);
            return chart;
        });
    },
    error: function (error) {
        console.log(error);
    }
});


/*
 *  Make ajax call to `label_timing` route.  This will fetch data to populate
 *  the boxplot/candlestick chart and show how long it takes each user to
 *  annotate data.
 */
$.ajax({
    method: 'GET',
    url: '/api/label_timing/' + {{ project.pk }} + '/',
    success: function (response) {
        nv.addGraph(function() {
            var chart = nv.models.boxPlotChart()
                .x(function(d) { return d.label })
                .staggerLabels(true)
                .maxBoxWidth(75) // prevent boxes from being incredibly wide
                .yDomain([0, response.yDomain])
            ;
            chart.xAxis
                .axisLabel("User")
                .axisLabelDistance(15)
                .showMaxMin(false)
            ;
            chart.yAxis
                .axisLabel("Time to Label (s)")
                .axisLabelDistance(-5)
                .tickFormat(d3.format(','))
            ;
            chart.noData("Insufficient labeled data -- please code more documents");
            d3.select('#timer_chart svg')
                .datum(response.data)
                .call(chart);
            nv.utils.windowResize(chart.update);
            return chart;
        });
    },
    error: function (error) {
        console.log(error);
    }
});


/*
 *  Make ajax call to `model_metrics` route.  This will fetch data to populate
 *  the line chart and show how well the model is training over time.
 */
$.ajax({
    method: 'GET',
    url: '/api/model_metrics/' + {{ project.pk }} + '/?metric=accuracy',
    success: function (response) {
        var chart;
        nv.addGraph(function() {
            chart = nv.models.lineChart()
                .options({
                    duration: 300,
                    useInteractiveGuideline: true,
                    forceY: [0, 1]
                })
            ;
            chart.xAxis
                .axisLabel("Run ID")
            ;

            chart.yAxis
                .axisLabel('Metric')
                .tickFormat(function(d) {
                    return d3.format(',.2f')(d);
                })
            ;
            chart.noData("Insufficient training data -- please code more documents");
            d3.select('#metric_chart svg')
                .datum(response)
                .call(chart);
            nv.utils.windowResize(chart.update);
            return chart;
        });
        $('#metric_select').change(function () {
            $.ajax({
                method: 'GET',
                url: '/api/model_metrics/' + {{ project.pk }} + '/?metric=' + $(this).val(),
                success: function (response) {
                    d3.select('#metric_chart svg').datum(response).transition().duration(300).call(chart);
                    nv.utils.windowResize(chart.update);
                },
                error: function (error) {
                    console.log(error);
                }
            });
            var choice = $(this).val();
            var children = $("#model_metrics").children();
            if(choice === "accuracy")
            {
              $("#model_metrics").text("Model Metrics: Accuracy ");
              $("#model_metrics").append(children);
              $("#model_metric_icon").attr("title","The percent guessed correctly by the model.")
            }
            else if(choice === "f1")
            {
              $("#model_metrics").text("Model Metrics: F1 Score ");
              $("#model_metrics").append(children);
              $("#model_metric_icon").attr("title","A common model evaluation "
              +"metric with a similar interpretation to accuracy but penalizes "
              +"for poor precision or recall. This is an important consideration"
              +" when predicting rare classes. Formula: 2*((Precision * Recall)/(Precision + Recall))")
            }
            else if(choice === "precision")
            {
              $("#model_metrics").text("Model Metrics: Precision ");
              $("#model_metrics").append(children);
              $("#model_metric_icon").attr("title","Indicates how precise the"
              +" active learning model is at correctly predicting the category"
              +" in the test set. Formula:  True Positives/(True Positives + False Positives)")
            }
            else {
              $("#model_metrics").text("Model Metrics: Recall ");
              $("#model_metrics").append(children);
              $("#model_metric_icon").attr("title","Indicates how comprehensive"
              +" the active learning model is at identifying documents of a "
              +"particular category in the test set.  Formula:  "
              +"True Positives/(True Positives + False Negatives)")
            }
            $(function () {
              $('[data-toggle="tooltip"]').tooltip()
            });
        });
    },
    error: function (error) {
        console.log(error);
    }
});

$(document).ready(function() {
    /*
     *  Activate DataTable script to create the labeled data DataTable
     */
    $('#labeled_data_table').DataTable({
        "ajax": '/api/data_coded_table/' + {{ project.pk }} + '/',
        "columns": [
            { "data": "Text", "width": "70%"},
            { "data": "Label", "searchable": false, "width": "15%" },
            { "data": "Coder", "searchable": false, "width": "15%" }
        ],
        "oLanguage": {
            "sSearch": "Filter Text: ",
            "sEmptyTable": "Insufficient labeled data -- please code more documents"
        },
        "initComplete": function (settings, json) {
            $this = $(this)
            $this.css({'table-layout':'fixed'});
            $this.find('tr td:first-child').addClass('showData');
        },
        "rowCallback": function (row, data) {
          $('td:nth-child(1)',row).addClass('showData');
        }
    });

    /*
     *  Activate DataTable script to create the predicted data DataTable
     */
    $('#predicted_data_table').DataTable({
        "ajax": '/api/data_predicted_table/' + {{ project.pk }} + '/',
        "columns": [
            { "data": "Text", "width": "70%" },
            { "data": "Probability",
              "searchable": false,
              "width": "15%",
              "render": function (data, type, row) {
                return d3.format('.2%')(data);
              },
            },
            { "data": "Label", "searchable": false, "width": "15%" }
        ],
        "oLanguage": {
            "sSearch": "Filter Text: ",
            "sEmptyTable": "Insufficient training data -- please code more documents"
        },
        "initComplete": function (settings, json) {
            $this = $(this)
            $this.css({'table-layout':'fixed'});
            $this.find('tr td:first-child').addClass('showData');
        },
        "rowCallback": function (row, data) {
          $('td:nth-child(1)',row).addClass('showData');
        }
    });

    /*
     *  Activate DataTable script to create the labeled data DataTable
     */
    var change_history_table = $('#label_changes_data_table').DataTable({
        "ajax": '/api/data_change_log_table/' + {{ project.pk }} + '/',
        "columns": [
            {
              "className": 'details-control', "orderable": false,
              "data": null, "defaultContent": '', "width": "5%",
              "searchable": false,
            },

            { "data": "Text", "width": "60%", "className": "showData"},
            { "data": "Coder", "searchable": true, "width": "10%" },
            { "data": "Old Label", "searchable": true, "width": "10%" },
            { "data": "New Label", "searchable": true, "width": "10%" },
            { "data": "Timestamp", "searchable": false, "width": "10%" }

        ],
        "oLanguage": {
            "sSearch": "Filter Text: ",
            "sEmptyTable": "No label changes to display"
        },
        "initComplete": function (settings, json) {
            $this = $(this)
            $this.css({'table-layout':'fixed'});
            var columns = $this.find('tr').children()
            columns.addClass('showData');
        },
        "rowCallback": function (row, data) {
          $('td:nth-child(1)',row).addClass('showData');
          $('td:nth-child(5)',row).addClass('showData');
        }
    });


    $(function () {
       $('[data-toggle="tooltip"]').tooltip()
    });

    $('#label_changes_data_table tbody').on('click','td.details-control',function(){
        var tr = $(this).closest('tr');
        var row = change_history_table.row(tr);
        var columns = tr.children()
        columns.toggleClass('showData');
      });

});

/*
 *  Force window resize event when bootstrap tab navigation anchor is used
 *  This is needed because nvd3 charts are incorrectly sized if they are
 *  initially rendered while hidden.
 */
$(function () {
    $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
        window.dispatchEvent(new Event('resize'));
    });
});
</script>
{% endblock %}
