{% extends "base.html" %}
{% load render_bundle from webpack_loader %}

{% block title %}Admin Page{% endblock %}
{% block heading %}Admin - {{object}}{% endblock %}

{% block content %}
<div class="card full">
    <div class="cardface">
        <h1>{{ project.name }}</h1>
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a data-toggle="tab" href="#summary" class="nav-link active">Summary</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#distribution" class="nav-link">Label Distribution</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#labels" class="nav-link">Data Labels</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#predictions" class="nav-link">Data Predictions</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#timer" class="nav-link">Time To Label</a>
                </li>
            </ul>
        </div>
        <div class="tab-content">
            <div id="summary" class="tab-pane fade in active">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <p>
                                This is the admin page. Admin stuff goes here.
                            </p>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer ut accumsan ex. Nam tincidunt, ligula tempor efficitur tempor, lorem urna ullamcorper lacus, eget luctus odio tellus quis nibh. Suspendisse est elit, faucibus ac orci id, maximus blandit lacus. In feugiat velit condimentum, luctus turpis sed, placerat tellus. Vivamus pellentesque ut velit nec ornare. Phasellus efficitur tempus metus. Ut accumsan sit amet turpis at iaculis. Morbi nec vehicula lectus. Nunc eu nunc felis. Vestibulum sit amet convallis diam. Integer vel risus at dolor suscipit gravida in sed mauris. Nullam interdum porttitor pulvinar.
                            </p>
                            <p>
                                Fusce sit amet nibh blandit nisi finibus pharetra. Vestibulum at tempor nunc. Nulla ac tincidunt tellus. Integer nisl orci, pulvinar at augue et, maximus tempor tortor. Fusce auctor pulvinar bibendum. In placerat risus et lacus auctor, non varius arcu hendrerit. Nulla cursus pulvinar hendrerit. Nam vitae sapien sed est pulvinar dapibus.
                            </p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-12">
                            <p>
                                Click the button below to download your data with their labels
                            </p>
                            <a class="btn btn-primary" id="download_btn">Download Data</a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="distribution" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <div id="distribution_chart" style="height:500px">
                                <svg class="nvd3-svg"></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="labels" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="labeled_data_table" class="table table-hover" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th>Text</th>
                                        <th>Label</th>
                                        <th>Coder</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="predictions" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="predicted_data_table" class="table table-hover" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th>Text</th>
                                        <th>Predicted Probability</th>
                                        <th>Predicted Label</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="timer" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <div id="timer_chart" style="height:500px">
                                <svg class="nvd3-svg"></svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts_body %}
<script>
/*
 *  When download button is pressed request the csv file, add the data as a blob
 *  to a new anchor element, and trigger a click event on that anchor element
 *  to prompt the download file popup
 */
$("#download_btn").on("click", function() {
    xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        var a, today;
        if (xhttp.readyState === 4 && xhttp.status === 200) {
            a = document.createElement('a');
            a.href = window.URL.createObjectURL(xhttp.response);
            today = new Date();
            a.download = "project_" + {{ project.pk }} + '_labels_' + today.toDateString().split(" ").join("_") + ".csv";
            a.style.display = 'none';
            document.body.appendChild(a);
            return a.click();
        }
    };
    xhttp.open("GET", "/api/download_data/" + {{ project.pk }} + "/", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.responseType = 'blob';
    xhttp.send();
});


/*
 *  Make ajax call to `label_distribution` route.  This will fetch data to
 *  populate the discrete multi bar chart and show the label distribution
 *  per user.
 */
$.ajax({
    method: "GET",
    url: '/api/label_distribution/' + {{ project.pk }} + '/',
    success: function (response) {
        nv.addGraph(function() {
            var chart = nv.models.multiBarChart()
                .barColor(d3.scale.category20().range())
                .duration(300)
                .margin({bottom: 70, left: 70})
                .groupSpacing(0.1)
            ;
            chart.xAxis
                .axisLabel("User")
                .axisLabelDistance(15)
                .showMaxMin(false)
            ;
            chart.yAxis
                .axisLabel("Number of Data Annotated")
                .axisLabelDistance(-5)
                .tickFormat(d3.format(',.01f'))
            ;
            d3.select('#distribution_chart svg')
                .datum(response)
                .call(chart);
            nv.utils.windowResize(chart.update);
            return chart;
        });
    },
    error: function (error) {
        console.log(error);
    }
});


/*
 *  Make ajax call to `label_timing` route.  This will fetch data to populate
 *  the boxplot/candlestick chart and show how long it takes each user to
 *  annotate data.
 */
$.ajax({
    method: 'GET',
    url: '/api/label_timing/' + {{ project.pk }} + '/',
    success: function (response) {
        nv.addGraph(function() {
            var chart = nv.models.boxPlotChart()
                .x(function(d) { return d.label })
                .staggerLabels(true)
                .maxBoxWidth(75) // prevent boxes from being incredibly wide
                .yDomain([0, response.yDomain])
            ;
            chart.xAxis
                .axisLabel("User")
                .axisLabelDistance(15)
                .showMaxMin(false)
            ;
            chart.yAxis
                .axisLabel("Time to Label (s)")
                .axisLabelDistance(-5)
                .tickFormat(d3.format(','))
            ;
            d3.select('#timer_chart svg')
                .datum(response.data)
                .call(chart);
            nv.utils.windowResize(chart.update);
            return chart;
        });
    },
    error: function (error) {
        console.log(error);
    }
});


/*
 *  Activate DataTable script to create the labeled data DataTable
 */
$(document).ready(function() {
    $('#labeled_data_table').DataTable({
        "ajax": '/api/data_coded_table/' + {{ project.pk }} + '/',
        "lengthChange": false,
        "columns": [
            { "data": "Text" },
            { "data": "Label" },
            { "data": "Coder" }
        ]
    });
});


/*
 *  Activate DataTable script to create the predicted data DataTable
 */
$(document).ready(function() {
    $('#predicted_data_table').DataTable({
        "ajax": '/api/data_predicted_table/' + {{ project.pk }} + '/',
        "lengthChange": false,
        "columns": [
            { "data": "Text" },
            { "data": "Probability" },
            { "data": "Label" }
        ]
    });
});


/*
 *  Force window resize event when bootstrap tab navigation anchor is used
 *  This is needed because nvd3 charts are incorrectly sized if they are
 *  initially rendered while hidden.
 */
$(function () {
    $(document).on('shown.bs.tab', 'a[data-toggle="tab"]', function (e) {
        window.dispatchEvent(new Event('resize'));
    });
});
</script>
{% endblock %}