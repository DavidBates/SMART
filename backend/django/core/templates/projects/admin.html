{% extends "base.html" %}
{% load render_bundle from webpack_loader %}

{% block title %}Admin Page{% endblock %}
{% block heading %}Admin - {{object}}{% endblock %}

{% block content %}
<div class="card full">
    <div class="cardface">
        <h1>{{ project.name }}</h1>
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs">
                <li class="nav-item">
                    <a data-toggle="tab" href="#summary" class="nav-link active">Summary</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#distribution" class="nav-link">Label Distribution</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#labels" class="nav-link">Data Labels</a>
                </li>
                <li class="nav-item">
                    <a data-toggle="tab" href="#predictions" class="nav-link">Data Predictions</a>
                </li>
            </ul>
        </div>
        <div class="tab-content">
            <div id="summary" class="tab-pane fade in active">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <p>
                                This is the admin page. Admin stuff goes here.
                            </p>
                            <p>
                                Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer ut accumsan ex. Nam tincidunt, ligula tempor efficitur tempor, lorem urna ullamcorper lacus, eget luctus odio tellus quis nibh. Suspendisse est elit, faucibus ac orci id, maximus blandit lacus. In feugiat velit condimentum, luctus turpis sed, placerat tellus. Vivamus pellentesque ut velit nec ornare. Phasellus efficitur tempus metus. Ut accumsan sit amet turpis at iaculis. Morbi nec vehicula lectus. Nunc eu nunc felis. Vestibulum sit amet convallis diam. Integer vel risus at dolor suscipit gravida in sed mauris. Nullam interdum porttitor pulvinar.
                            </p>
                            <p>
                                Fusce sit amet nibh blandit nisi finibus pharetra. Vestibulum at tempor nunc. Nulla ac tincidunt tellus. Integer nisl orci, pulvinar at augue et, maximus tempor tortor. Fusce auctor pulvinar bibendum. In placerat risus et lacus auctor, non varius arcu hendrerit. Nulla cursus pulvinar hendrerit. Nam vitae sapien sed est pulvinar dapibus.
                            </p>
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col-md-12">
                            <p>
                                Click the button below to download your data with their labels
                            </p>
                            <a class="btn btn-primary" id="download_btn">Download Data</a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="distribution" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <canvas id="label-distribution-chart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="labels" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="labeled_data_table" class="table table-hover" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th>Text</th>
                                        <th>Label</th>
                                        <th>Coder</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div id="predictions" class="tab-pane fade in">
                <div class="cardface">
                    <div class="row">
                        <div class="col-md-12">
                            <table id="predicted_data_table" class="table table-hover" cellspacing="0" width="100%">
                                <thead>
                                    <tr>
                                        <th>Text</th>
                                        <th>Label</th>
                                        <th>Probability</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_body %}
<script>
$("#download_btn").on("click", function() {
    xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        var a, today;
        if (xhttp.readyState === 4 && xhttp.status === 200) {
            a = document.createElement('a');
            a.href = window.URL.createObjectURL(xhttp.response);
            today = new Date();
            a.download = "project_" + {{ project.pk }} + '_labels_' + today.toDateString().split(" ").join("_") + ".csv";
            a.style.display = 'none';
            document.body.appendChild(a);
            return a.click();
        }
    };
    xhttp.open("GET", "/api/download_data/" + {{ project.pk }} + "/", true);
    xhttp.setRequestHeader("Content-Type", "application/json");
    xhttp.responseType = 'blob';
    xhttp.send();
});

$.ajax({
    method: "GET",
    url: '/api/label_distribution/' + {{ project.pk }} + '/',
    success: function (chart_data) {
        var generated_patterns = pattern.generate(['#b3e2cd','#fdcdac','#cbd5e8','#f4cae4','#e6f5c9']);

        for(var i = 0; i < chart_data.datasets.length; i++) {
            chart_data.datasets[i]['backgroundColor'] = generated_patterns[i % generated_patterns.length];
        }
        var ctx = document.getElementById('label-distribution-chart').getContext("2d");
        var label_dist_chart = new Chart(ctx, {
            type: 'bar',
            data: chart_data,
            options: {
                legend: {
                    position: 'bottom'
                },
                tooltips: {
                    displayColors: false
                },
                title: {
                    display: true,
                    text: 'Label Distribution per Coder'
                }
            }
        })
    },
    error: function (error) {
        console.log(error);
    }
});

$(document).ready(function() {
    $('#labeled_data_table').DataTable({
        "ajax": '/api/data_coded_table/' + {{ project.pk }} + '/',
        "lengthChange": false,
        "columns": [
            { "data": "Text" },
            { "data": "Label" },
            { "data": "Coder" }
        ]
    });
});

$(document).ready(function() {
    $('#predicted_data_table').DataTable({
        "ajax": '/api/data_predicted_table/' + {{ project.pk }} + '/',
        "lengthChange": false,
        "columns": [
            { "data": "Text" },
            { "data": "Label" },
            { "data": "Probability" }
        ]
    });
});

</script>
{% endblock %}