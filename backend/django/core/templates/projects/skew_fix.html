{% extends "base.html" %}
{% load render_bundle from webpack_loader %}
{% block title %}Skew Page{% endblock %}
{% block heading %}Skew - {{object}}{% endblock %}

{% block content %}
<div class="card full">
  <div class="cardface">
    <div class="row">
      <div class="btn-group pull-left" role="group" aria-label="Admin Controls">
        <a class="btn btn-primary" href="{% url 'projects:project_admin' project.pk %}" role="button">
              Back to Admin Page
        </a>
      </div>
    </div>
    <h2>{{ project.name }}</h2>
    <div class="row">
      <div class="col-md-6">
        <h3>Label Distribution</h3>
        <div id="distribution_chart_summ" style="height:300px">
          <svg class="nvd3-svg"></svg>
        </div>
      </div>
    </div>
    <div class="row">
      <p>
      Below are the unlabeled data that are not in a queue. This page allows an admin to
      manually search for and annotate data in the case of a particularly bad data skew.
      </p>
      <br/>
      <p>To annotate, click on a data entry below and select the label from the expanded list of
        labels.
    </div>
    <div class="row">
      <div>
      </div>
      <h3>Unlabeled Data</h3>
      <table id="unlabeled_data_table" class="table table-hover table-striped table-bordered" cellspacing="0" width="100%">
        <thead>
          <tr>
            <th></th>
            <th>Text</th>
          </tr>
        </thead>
      </table>
    </div>

  </div>
</div>

{% endblock %}

{% block scripts_body %}
<script>
// Create variables needed for nvd3 chart manipulation
var chart;
var charData;
var labelData;

/* Synchornous ajax call that sets the value of labelData to the data returned
 * from the label_distribution_inverted api call
 */
function get_data() {
  return $.ajax({
    method: "GET",
    url: '/api/label_distribution_inverted/' + {{ project.pk }} + '/',
    async: false,
    success: function (response) {
      labelData = response;
    },
    error: function (error) {
      console.log(error);
    }
  });
}

/* Function that updates the nvd3 chart by call get_data and then transitioning
 * the chartData variable
 */
function update_chart() {
  get_data();

  chartData.datum(labelData).transition().duration(500).call(chart);
};

/* Function that fires when a labelButton is clicked. This gets the label id
 * calls the label_skew_label api, removes the labeled data from the table,
 * and updates the label distribution chart
 */
function labelButtonClicked(event) {
  var data_id = this.parentElement.parentElement.getAttribute('name');
  var label_id = this.id;
  $.ajax({
    method: 'POST',
    url: '/api/label_skew_label/' + data_id + '/',
    data: {
      labelID: label_id,
      labeleing_time: null
    },
    xhrFields: {
      withCredentials: true
    },
    success: function (response) {
      //Need to remove the row from the table
      $('#unlabeled_data_table').DataTable().rows("."+data_id).remove().draw(false);
      update_chart();
    },
    error: function (error) {
      console.log(error);
    }
  });
}

/* Function that formats the child rows of the unlabled data table */
function format_hidden_rows(rowData){
  var buttonDiv = '';
  buttonDiv += '<div class="text-center" name=' + rowData.ID + '>';
  buttonDiv += '<div class="center-block">'
  {% for label in project.labels.all %}
  buttonDiv += '<button type="button" class="btn btn-primary btn-spacing" id="{{ label.id }}">{{ label }}</button>';
  {% endfor %}
  buttonDiv += '</div></div>';
  return buttonDiv;
}

$(document).ready(function() {
  /*
   *  Activate DataTable script to create the unlabeled data DataTable
   */
   var unlabeled_table = $('#unlabeled_data_table').DataTable({
    "ajax": '/api/data_unlabeled_table/' + {{ project.pk }} + '/',
    "order": [],
    "columns": [
      {
        "className": 'details-control', "orderable": false,
        "data": null, "defaultContent": '', "width": "5%",
        "searchable": false,
      },
      { "data": "Text", "width": "95%" },
      {"data":"ID" , "visible": false }
    ],
    "oLanguage": {
      "sSearch": "Filter Text: ",
      "sEmptyTable": "No unlabeled data available. Check the annotate page for the final batch."
    },
    "initComplete": function (settings, json) {
      $this = $(this)
      $this.css({'table-layout':'fixed'});
    },
    "rowCallback": function (row, data) {
      $('td:nth-child(2)',row).addClass('showData');
    }
   });

  /*
   *  This function fires whenever a row of the table is clicked. If it is a
   *  outer row, it should spawn or hide the list of buttons. The child rows
   *  also trigger this function but it should do nothing there.
   */
  $('#unlabeled_data_table tbody').on('click','td.details-control',function(){
    var tr = $(this).closest('tr');
    var row = unlabeled_table.row(tr);

    //Assign the data id as a class so we can remove this row later
    var id = String(row.data().ID);
    tr.addClass(id);
    var columns = tr.children()
    if(row.child.isShown())
    {
      row.child.hide();
      tr.removeClass('shown');
      columns.addClass('showData');
    }
    else{
      row.child(format_hidden_rows(row.data())).show();
      $(row.child()).find('button').click(labelButtonClicked);
      tr.addClass('shown');
      columns.removeClass('showData');
    }
  });

  /* Create the label chart */
  nv.addGraph(function() {
    chart = nv.models.multiBarChart()
      .color(["#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f","#e5c494","#b3b3b3"])
      .duration(300)
      .margin({bottom: 70, left: 70})
      .groupSpacing(0.1)
      .stacked(true)
    ;
    chart.xAxis
      .axisLabel("Label")
      .axisLabelDistance(15)
      .showMaxMin(false)
    ;
    chart.yAxis
      .axisLabel("Number of Data Annotated")
      .axisLabelDistance(-5)
      .tickFormat(d3.format(',.01f'))
    ;
    chart.noData("Insufficient labeled data -- please code more documents");
    get_data();

    chartData = d3.select('#distribution_chart_summ svg').datum(labelData);
    chartData.transition().duration(500).call(chart);
    nv.utils.windowResize(chart.update);

    return chart;
  });

});
</script>
{% endblock %}
